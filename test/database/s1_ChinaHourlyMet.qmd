```{r}
#! /usr/bin/Rscript --no-init-file
# Dongdong Kong ----------------------------------------------------------------
# Copyright (c) 2022 Dongdong Kong. All rights reserved.
```

## 登录数据库
```{r}
library(Ipaper)
# source('scripts/main_pkgs.R')
config = yaml::read_yaml("env/db_userinfo.yml")
dbinfo = config$Kong

con = open_mysql(dbinfo, 1)
con
```

```{r}
copy_to(con, mtcars, overwrite=TRUE, indexes=c("cyl"))
table = tbl(con, "mtcars")
data = collect(table)[1:10, ]

rows_append(table, data, copy=TRUE)
rows_append(table, data, copy=TRUE, in_place=TRUE)
```

## 分析数据

> 站点的索引可以发挥很大作用
```{r}
system.time({
  d = table |> filter(site==50136)
  collect(d)
})
  #  user  system elapsed
  #  0.00    0.01    0.28
```

> 测试日期的索引
```{r}
date0 = make_date(2020)
system.time({
  # d = table |> filter(date==date0)
  d = table |> filter(year==2020L, month==1L, day==1L)
  collect(d)
})
```
